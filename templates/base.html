{% load static %}
<!DOCTYPE html>
<html lang="ru"
      x-data="{
        isSidebarOpen: false,
        sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true'
      }"
      x-watch="sidebarCollapsed, value => localStorage.setItem('sidebarCollapsed', value)"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}GAT Report{% endblock %}</title>

    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* === COMPACT WIDGET STYLES (RIGHT SIDE FIX) === */
        
        .ai-widget-wrapper {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            font-family: 'Inter', system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        }

        /* –ö–Ω–æ–ø–∫–∞ (Launcher) */
        .ai-launcher {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid white;
        }
        .ai-launcher:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5); }
        .ai-launcher:active { transform: scale(0.95); }

        /* –û–∫–Ω–æ —á–∞—Ç–∞ */
        .ai-window {
            width: 340px;
            height: 480px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-bottom: 16px;
            transform-origin: bottom right;
            border: 1px solid #f1f5f9;
        }

        /* --- –ê–î–ê–ü–¢–ò–í –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• (–ò–°–ü–†–ê–í–õ–ï–ù–û) --- */
        @media (max-width: 640px) {
    .ai-widget-wrapper {
        right: 16px;      /* –ü—Ä–∏–∂–∏–º–∞–µ—Ç –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        left: auto;       /* –£–±–∏—Ä–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        align-items: flex-end;
    }
}
            
            .ai-window {
                width: 300px;     /* –ß—É—Ç—å —É–∂–µ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
                height: 450px;
                position: absolute;
                bottom: 70px;     /* –ü–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π */
                right: 0;         /* –ü—Ä–∏–∂–∞—Ç–æ –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é –≤—Ä–∞–ø–ø–µ—Ä–∞ */
                margin-bottom: 0;
            }
            
            /* –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω —Å–æ–≤—Å–µ–º —É–∑–∫–∏–π, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É, –Ω–æ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —Å–ø—Ä–∞–≤–∞ */
        }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (Header, Messages, Input) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π... */
        .ai-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 16px;
            color: white;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 13px;
            line-height: 1.5;
            position: relative;
        }
        .msg-ai {
            align-self: flex-start;
            background: #fff;
            color: #334155;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid #e2e8f0;
        }
        .msg-user {
            align-self: flex-end;
            background: #6366f1;
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2);
        }

        .ai-footer {
            padding: 12px;
            background: #fff;
            border-top: 1px solid #f1f5f9;
        }
        .ai-input-box {
            display: flex;
            align-items: center;
            background: #f1f5f9;
            border-radius: 24px;
            padding: 4px 4px 4px 16px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .ai-input-box:focus-within {
            background: #fff;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .ai-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 13px;
            max-height: 80px;
            resize: none;
            padding: 8px 0;
        }
        .ai-send-btn {
            width: 36px;
            height: 36px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 8px;
            transition: background 0.2s;
        }
        .ai-send-btn:hover { background: #4f46e5; }
        .ai-send-btn:disabled { background: #cbd5e1; }

        .pop-enter-active, .pop-leave-active { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .pop-enter-from, .pop-leave-to { opacity: 0; transform: scale(0.9) translateY(20px); }
        .pop-enter-to, .pop-leave-from { opacity: 1; transform: scale(1) translateY(0); }
    </style>

    {% block head %}{% endblock %}
</head>

<body class="font-sans bg-gray-100" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

{# === –û–°–ù–û–í–ù–û–ô –õ–ï–ô–ê–£–¢ === #}
<div class="flex h-screen overflow-hidden"
     @force-refresh.window="setTimeout(() => window.location.reload(), 2000)"
>
    {# 1. –ú–û–ë–ò–õ–¨–ù–´–ô –°–ê–ô–î–ë–ê–† #}
    <div class="lg:hidden">
        <div x-show="isSidebarOpen" x-transition.opacity @click="isSidebarOpen = false" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-30" x-cloak></div>
        <div x-show="isSidebarOpen" class="fixed inset-y-0 left-0 flex-shrink-0 z-40" x-cloak>
            <div class="relative flex-1 flex flex-col w-full bg-gray-800 h-full">
                <div class="absolute top-0 right-0 -mr-12 pt-2">
                    <button @click="isSidebarOpen = false" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <svg class="h-6 w-6 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                {% include 'components/sidebar.html' %}
            </div>
        </div>
    </div>

    {# 2. –î–ï–°–ö–¢–û–ü–ù–´–ô –°–ê–ô–î–ë–ê–† #}
    <div class="hidden lg:flex lg:flex-shrink-0">
        <div class="flex flex-col transition-all duration-300 bg-gray-800" :class="{'w-64': !sidebarCollapsed, 'w-20': sidebarCollapsed}">
            {% include 'components/sidebar.html' %}
        </div>
    </div>

    {# 3. –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ #}
    <div class="flex flex-col w-0 flex-1 overflow-hidden">
        {% include 'components/header.html' %}
        <main class="flex-1 relative overflow-y-auto focus:outline-none scroll-smooth">
            <div class="py-6 px-4 sm:px-6 lg:px-8 pb-32"> 
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
</div>

{# === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ò –ú–û–î–ê–õ–ö–ò === #}
<div x-data="{ show: false, message: '', type: 'success' }" @show-message.window="message = $event.detail.text; type = $event.detail.type; show = true; setTimeout(() => show = false, 8000);" x-show="show" x-transition class="fixed top-5 left-1/2 -translate-x-1/2 z-[60] rounded-lg p-4 max-w-md w-full border-l-4 shadow-lg bg-white" :class="{'border-green-500 text-green-700 bg-green-50': type === 'success', 'border-red-500 text-red-700 bg-red-50': type === 'error'}" style="display: none;" x-cloak><p class="font-bold text-center" x-text="message"></p></div>
<div x-data="{ showNested: false, nestedUrl: '' }" x-show="showNested" @open-nested-modal.window="showNested = true; nestedUrl = $event.detail.url; $nextTick(() => { htmx.ajax('GET', nestedUrl, { target: '#nested-modal-content' }); });" @close-nested-modal.window="showNested = false; htmx.find('#nested-modal-content').innerHTML = '';" x-transition.opacity class="fixed inset-0 z-[70] bg-gray-900 bg-opacity-60 flex items-center justify-center p-4" style="display: none;" x-cloak><div @click.away="showNested = false" class="w-full max-w-lg relative bg-white rounded-lg overflow-hidden"><div id="nested-modal-content"></div></div></div>

{# === üî• COMPACT AI WIDGET (Final) === #}
<div x-data="{ 
        isOpen: false, 
        inputVal: '',
        scrollToBottom() { 
            this.$nextTick(() => { 
                const el = this.$refs.chatHistory; 
                if(el) el.scrollTop = el.scrollHeight; 
            }); 
        }
     }" 
     class="ai-widget-wrapper"
     x-cloak>

    {# --- –û–ö–ù–û –ß–ê–¢–ê --- #}
    <div x-show="isOpen" 
         x-transition:enter="pop-enter-active"
         x-transition:enter-start="pop-enter-from"
         x-transition:enter-end="pop-enter-to"
         x-transition:leave="pop-leave-active"
         x-transition:leave-start="pop-leave-from"
         x-transition:leave-end="pop-leave-to"
         class="ai-window">
         
        {# –®–∞–ø–∫–∞ #}
        <div class="ai-header">
            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-sm backdrop-blur-sm">ü§ñ</div>
            <div>
                <p class="text-sm font-bold leading-none">GAT –ü–æ–º–æ—â–Ω–∏–∫</p>
                <p class="text-[10px] opacity-80 mt-1 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span>Online</p>
            </div>
            <button @click="isOpen = false" class="ml-auto p-1 hover:bg-white/10 rounded lg:hidden">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>

        {# –°–æ–æ–±—â–µ–Ω–∏—è #}
        <div x-ref="chatHistory" id="widget-chat-history" class="ai-messages">
            <div class="msg-bubble msg-ai">
                –ü—Ä–∏–≤–µ—Ç! üëã –Ø –≤–∏–∂—É –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ. –°–ø—Ä–æ—Å–∏ –º–µ–Ω—è: "–ö–∞–∫–∞—è —à–∫–æ–ª–∞ –ª–∏–¥–∏—Ä—É–µ—Ç?" üöÄ
            </div>
            
            {% if request.session.ai_chat_history %}
                {% for msg in request.session.ai_chat_history %}
                    <div class="msg-bubble {% if msg.role == 'user' %}msg-user{% else %}msg-ai{% endif %}">
                        {{ msg.text|linebreaksbr }}
                    </div>
                {% endfor %}
            {% endif %}
            
            <div id="ai-loading" class="htmx-indicator text-xs text-indigo-500 font-medium flex items-center gap-1">
                <span class="animate-bounce">‚óè</span> –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>

        {# –í–≤–æ–¥ #}
        <div class="ai-footer">
            {% if user.is_authenticated %}
                <form hx-post="{% url 'core:ai_ask_api' %}" 
                      hx-target="#widget-chat-history" 
                      hx-swap="beforeend"
                      hx-indicator="#ai-loading"
                      @submit="setTimeout(() => { inputVal = ''; scrollToBottom(); }, 50)"
                >
                    {% csrf_token %}
                    <div class="ai-input-box">
                        <textarea name="question" x-model="inputVal" rows="1" class="ai-input" placeholder="–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å..." @keydown.enter.prevent="if(!event.shiftKey) $el.form.querySelector('button').click()"></textarea>
                        <button type="submit" :disabled="!inputVal.trim()" class="ai-send-btn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="text-center text-xs text-gray-500"><a href="{% url 'core:login' %}" class="text-indigo-600 font-bold">–í–æ–π–¥–∏—Ç–µ</a> –¥–ª—è —á–∞—Ç–∞.</div>
            {% endif %}
        </div>
    </div>

    {# --- –ö–ù–û–ü–ö–ê (LAUNCHER) --- #}
    <div @click="isOpen = !isOpen" class="ai-launcher">
        <svg x-show="!isOpen" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
        <svg x-show="isOpen" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </div>
</div>

{% block scripts %}{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if messages %}
            {% for message in messages %}
                window.dispatchEvent(new CustomEvent('show-message', { detail: { text: '{{ message|escapejs }}', type: '{{ message.tags }}' } }));
            {% endfor %}
        {% endif %}
        document.body.addEventListener('htmx:configRequest', (event) => { event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}'; });
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if(evt.detail.target.id === 'widget-chat-history') { evt.detail.target.scrollTop = evt.detail.target.scrollHeight; }
        });
    });
</script>

</body>
</html>