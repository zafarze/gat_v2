{% load static %}
<!DOCTYPE html>
<html lang="ru" x-data="{ isSidebarOpen: false, sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true' }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}GAT Report{% endblock %}</title>
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        .ai-widget-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; align-items: flex-end; gap: 16px; }
        .ai-chat-window { width: 350px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid #e5e7eb; display: flex; flex-direction: column; overflow: hidden; }
        .ai-fab-button { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border: 4px solid white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }
        .ai-fab-button:hover { transform: scale(1.05); }
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-request.htmx-indicator { opacity: 1; }
    </style>
    {% block head %}{% endblock %}
</head>

<body class="font-sans bg-gray-100" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

<div class="flex h-screen overflow-hidden">
    <div class="hidden lg:flex lg:flex-shrink-0">
        <div class="flex flex-col bg-gray-800" :class="{'w-64': !sidebarCollapsed, 'w-20': sidebarCollapsed}">
            {% include 'components/sidebar.html' %}
        </div>
    </div>
    <div class="flex flex-col w-0 flex-1 overflow-hidden">
        {% include 'components/header.html' %}
        <main class="flex-1 relative overflow-y-auto p-6 scroll-smooth">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<div x-data="{ 
        isOpen: false, 
        inputVal: '',
        scrollToBottom() { this.$nextTick(() => { const el = this.$refs.chatHistory; if(el) el.scrollTop = el.scrollHeight; }); }
     }" 
     x-init="scrollToBottom()"
     class="ai-widget-container">

    <div x-show="isOpen" x-transition.scale.origin.bottom.right class="ai-chat-window" style="display: none;">
        <div class="p-4 bg-indigo-600 text-white flex justify-between items-center shadow-md">
            <div class="flex items-center gap-2">
                <span class="text-xl">‚ú®</span>
                <div>
                    <h3 class="font-bold text-sm">GAT Assistant</h3>
                    <div class="flex items-center gap-1 text-xs opacity-80"><span class="w-2 h-2 bg-green-400 rounded-full"></span> Online</div>
                </div>
            </div>
            <button @click="isOpen = false" class="hover:bg-white/20 p-1 rounded">‚úï</button>
        </div>

        <div x-ref="chatHistory" id="widget-chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            <div class="flex items-start gap-2.5">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-lg border border-indigo-200">ü§ñ</div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 text-sm text-gray-800">
                    –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —à–∫–æ–ª—ã.
                </div>
            </div>
            {% if request.session.ai_chat_history %}
                {% for msg in request.session.ai_chat_history %}
                    {% if msg.role == 'user' %}
                        <div class="flex justify-end">
                            <div class="bg-indigo-600 text-white p-3 rounded-xl rounded-tr-none shadow-sm text-sm max-w-[85%]">{{ msg.text }}</div>
                        </div>
                    {% else %}
                        <div class="flex items-start gap-2.5">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-lg border border-indigo-200 flex-shrink-0">ü§ñ</div>
                            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 text-sm text-gray-800 max-w-[85%]">
                                <span class="font-bold text-indigo-600 block mb-1">GAT AI</span>
                                <div class="whitespace-pre-wrap">{{ msg.text }}</div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div id="ai-loading" class="htmx-indicator px-4 py-2 text-xs text-gray-500 bg-gray-50 flex items-center gap-2">
            <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce delay-75"></div>
            <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce delay-150"></div>
            –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...
        </div>

        <div class="p-3 bg-white border-t border-gray-100">
            <form hx-post="{% url 'core:ai_ask_api' %}" 
                  hx-target="#widget-chat-history" 
                  hx-swap="beforeend"
                  hx-indicator="#ai-loading"
                  @submit="inputVal = ''; scrollToBottom()" 
                  class="relative flex gap-2">
                {% csrf_token %}
                <input type="text" name="question" x-model="inputVal"
                       class="w-full bg-gray-100 border-0 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500"
                       placeholder="–°–ø—Ä–æ—Å–∏ –æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ..." autocomplete="off"
                       @keydown.enter.prevent="$refs.submitBtn.click()">
                <button type="submit" x-ref="submitBtn" :disabled="!inputVal.trim()"
                        class="bg-indigo-600 text-white p-2 rounded-xl disabled:opacity-50 hover:bg-indigo-700 transition">‚û§</button>
            </form>
        </div>
    </div>

    <button @click="isOpen = !isOpen; if(isOpen) scrollToBottom()" class="ai-fab-button">
        <span x-show="!isOpen" class="text-3xl">üí¨</span>
        <span x-show="isOpen" class="text-xl">‚úñ</span>
    </button>
</div>

{% block scripts %}{% endblock %}

<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if(evt.detail.target.id === 'widget-chat-history') {
            evt.detail.target.scrollTop = evt.detail.target.scrollHeight;
        }
    });
</script>

</body>
</html>