{% load custom_filters %}

<table class="min-w-full divide-y divide-gray-200 border-collapse">
    <thead class="bg-gray-50 sticky top-0 z-20 shadow-sm">
        <tr>
            {# --- –õ–ï–í–ê–Ø –ß–ê–°–¢–¨ (–ó–ê–ö–†–ï–ü–õ–ï–ù–ê) --- #}
            <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100 sticky left-0 z-30 border-r border-gray-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                ‚Ññ
            </th>
            <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100 z-10" style="min-width: 200px;">
                –§.–ò.–û.
            </th>
            <th rowspan="2" class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100 z-10">
                –ö–ª–∞—Å—Å
            </th>

            {# --- –ó–ê–ì–û–õ–û–í–ö–ò –ü–†–ï–î–ú–ï–¢–û–í (–° –ß–ï–†–ù–û–ô –õ–ò–ù–ò–ï–ô –°–õ–ï–í–ê) --- #}
            {% for header in table_header %}
                {# border-l-2 border-gray-900 = –ß–ï–†–ù–ê–Ø –õ–ò–ù–ò–Ø #}
                <th colspan="{{ header.questions|length }}" 
                    class="px-2 py-3 text-center text-xs font-bold text-gray-800 uppercase tracking-wider bg-gray-100 border-l-2 border-gray-900">
                    {{ header.subject.name }}
                </th>
            {% endfor %}

            {# --- –ò–¢–û–ì–ò (–¢–û–ñ–ï –û–¢–î–ï–õ–ï–ù–´ –ß–ï–†–ù–û–ô –õ–ò–ù–ò–ï–ô) --- #}
            <th rowspan="2" class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100 border-l-2 border-gray-900 z-10">
                –ò—Ç–æ–≥
            </th>
            <th rowspan="2" class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider bg-gray-100 border-l border-gray-200 z-10">
                –ú–µ—Å—Ç–æ
            </th>
        </tr>
        <tr>
            {# --- –ù–û–ú–ï–†–ê –í–û–ü–†–û–°–û–í --- #}
            {% for header in table_header %}
                {% for q_num in header.questions %}
                {# –õ–∏–Ω–∏—è —Å–ª–µ–≤–∞ —Ç–æ–ª—å–∫–æ —É –ü–ï–†–í–û–ì–û –≤–æ–ø—Ä–æ—Å–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ #}
                <th class="px-1 py-1 text-center text-[10px] font-medium text-gray-500 bg-gray-50 border-b border-gray-200 
                           {% if forloop.first %}border-l-2 border-gray-900{% else %}border-l border-gray-200{% endif %}">
                    {{ q_num }}
                </th>
                {% endfor %}
            {% endfor %}
        </tr>
    </thead>
    
    <tbody class="bg-white divide-y divide-gray-200">
        {% for data in students_data %}
        <tr class="hover:bg-gray-50 transition-colors duration-150">
            {# –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (–∑–∞–∫—Ä–µ–ø–ª–µ–Ω) #}
            <td class="px-3 py-2 whitespace-nowrap text-sm font-bold text-gray-700 sticky left-0 bg-white border-r border-gray-300 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                {{ forloop.counter }}
            </td>
            {# –§–ò–û #}
            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                <a href="{% url 'core:student_progress' data.student.pk %}" class="hover:text-indigo-600 hover:underline">
                    {{ data.student.full_name_ru }}
                </a>
            </td>
            {# –ö–ª–∞—Å—Å #}
            <td class="px-3 py-2 whitespace-nowrap text-center text-sm text-gray-500">
                {{ data.student.school_class.name }}
            </td>

            {# --- –û–¢–í–ï–¢–´ --- #}
            {% for header in table_header %}
                {% with subject_id_str=header.subject.id|stringformat:"s" %}
                {% with answers_dict=data.result.scores_by_subject|get_item:subject_id_str %}
                    {% for q_num in header.questions %}
                        {% with q_num_str=q_num|stringformat:"s" %}
                        {% with answer=answers_dict|get_item:q_num_str %}
                            
                            {# –Ø—á–µ–π–∫–∞ –æ—Ç–≤–µ—Ç–∞. –õ–∏–Ω–∏—è —Å–ª–µ–≤–∞, –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–µ–¥–º–µ—Ç–∞ #}
                            <td class="px-1 py-2 text-center text-xs border-r border-gray-100 
                                       {% if forloop.first %}border-l-2 border-gray-900{% endif %}">
                                
                                {% if answer is True %}
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-green-100 text-green-700 font-bold text-xs">1</span>
                                {% elif answer is False %}
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded bg-red-50 text-red-400 text-xs">0</span>
                                {% else %}
                                    <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            
                        {% endwith %}
                        {% endwith %}
                    {% endfor %}
                {% endwith %}
                {% endwith %}
            {% endfor %}

            {# --- –ò–¢–û–ì–û–í–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø --- #}
            <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-bold text-indigo-700 bg-gray-50 border-l-2 border-gray-900">
                {{ data.total_score }}
            </td>
            <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-bold text-gray-800 bg-gray-50 border-l border-gray-200">
                {% if data.position == 1 %}ü•á{% elif data.position == 2 %}ü•à{% elif data.position == 3 %}ü•â{% else %}{{ data.position }}{% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            {% with colspan_val=4 %}
                {% for header in table_header %}
                    {% with colspan_val=colspan_val|add:header.questions|length %}{% endwith %}
                {% endfor %}
                <td colspan="{{ colspan_val }}" class="px-6 py-10 text-center text-gray-500">
                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                </td>
            {% endwith %}
        </tr>
        {% endfor %}
    </tbody>
</table>