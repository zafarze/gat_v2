{# D:\New_GAT\templates\gat_tests\_school_card.html #}

<div id="school-card-{{ school.id }}" 
     class="data-card p-6 transition-all duration-300 mb-4"
     x-data="{ expanded: false }"> {# false = свернуто по умолчанию #}

    {# --- ШАПКА КАРТОЧКИ --- #}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-2">
        
        {# 1. ЛЕВАЯ ЧАСТЬ: Стрелка и Название (Кликабельно для открытия/закрытия) #}
        <div class="flex items-center gap-3 cursor-pointer group" @click="expanded = !expanded">
            {# Иконка стрелочки #}
            <div class="p-1 rounded-full group-hover:bg-indigo-50 transition-transform duration-200"
                 :class="{ 'rotate-180': expanded }">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            {# Название школы и счетчик #}
            <h2 class="text-xl font-bold text-gray-800 group-hover:text-indigo-700 transition-colors">
                {{ school.name }} 
                {# Счетчик (виден только когда свернуто) #}
                <span x-show="!expanded" x-cloak class="ml-2 text-sm font-normal text-gray-500">
                    ({{ tests|length }} тестов)
                </span>
            </h2>
        </div>

        {# 2. ПРАВАЯ ЧАСТЬ: Кнопки действий (Только для суперюзера) #}
        {% if user.is_superuser %}
        <div class="flex items-center gap-2 w-full sm:w-auto pl-10 sm:pl-0">
            
            {# ✨ НОВАЯ КНОПКА: КЛОНИРОВАТЬ ШКОЛУ ✨ #}
            {# Используем @click.stop, чтобы клик по кнопке не сворачивал карточку #}
            <button @click.stop="showModal = true"
                    hx-get="{% url 'core:gat_test_duplicate_school' school.pk %}?current_quarter={{ selected_quarter_id }}"
                    hx-target="#modal-content"
                    class="modern-btn secondary small flex items-center justify-center gap-1.5"
                    title="Скопировать все тесты этой школы в другую четверть">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                    <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" />
                </svg>
                <span class="hidden sm:inline">Клон Школы</span>
            </button>

            {# КНОПКА: НАЗНАЧИТЬ ТЕСТ #}
            <button @click.stop="showModal = true"
                    hx-get="{% url 'core:gat_test_add' %}?school={{ school.pk }}"
                    hx-target="#modal-content"
                    class="modern-btn primary small flex items-center justify-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span class="hidden sm:inline">Назначить</span>
                <span class="sm:hidden">Добавить</span>
            </button>
        </div>
        {% endif %}
    </div>

    {# --- ТЕЛО КАРТОЧКИ (ТАБЛИЦА) --- #}
    <div x-show="expanded" 
         x-collapse 
         x-cloak
         class="mt-4 border-t border-gray-100 pt-4">
        
        <div class="border border-gray-200 rounded-lg overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">Название</th>
                        {# Объединил Четверть и Дату/Статус для экономии места, или можно оставить как было #}
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">Дата / Статус</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">Результаты</th>
                        {% if user.is_superuser %}
                        <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {# Передаем тесты дальше в partial (где мы уже настроили красивые бейджи) #}
                    {% include 'gat_tests/_table_body_content.html' with tests=tests school=school %}
                </tbody>
            </table>
        </div>
    </div>
</div>